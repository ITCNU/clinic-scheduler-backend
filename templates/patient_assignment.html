{% extends "base.html" %}

{% block title %}Patient Assignment - CNU Dental Clinic Scheduler{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-user-plus me-2"></i>Patient Assignment</h1>
            <div>
                <button class="btn btn-primary" onclick="refreshData()">
                    <i class="fas fa-sync-alt me-2"></i>Refresh
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Operation Selection -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-stethoscope me-2"></i>Select Operation</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label for="operationSelect" class="form-label">Operation Type</label>
                        <select class="form-select" id="operationSelect">
                            <option value="">Select an operation...</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="patientId" class="form-label">Client ID</label>
                        <input type="text" class="form-control" id="patientId" placeholder="Enter Client ID">
                    </div>
                    <div class="col-md-3">
                        <label for="patientName" class="form-label">Client Name</label>
                        <input type="text" class="form-control" id="patientName" placeholder="Enter Client Name">
                    </div>
                    <div class="col-md-3">
                        <label for="weekFilter" class="form-label">Week Range</label>
                        <select class="form-select" id="weekFilter">
                            <option value="">All Weeks</option>
                        </select>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-3">
                        <label for="dayFilter" class="form-label">Day of Week</label>
                        <select class="form-select" id="dayFilter">
                            <option value="">All Days</option>
                            <option value="Monday">Monday</option>
                            <option value="Tuesday">Tuesday</option>
                            <option value="Wednesday">Wednesday</option>
                            <option value="Thursday">Thursday</option>
                            <option value="Friday">Friday</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="timeFilter" class="form-label">Time Period</label>
                        <select class="form-select" id="timeFilter">
                            <option value="">All Times</option>
                            <option value="AM">Morning (AM)</option>
                            <option value="PM">Afternoon (PM)</option>
                        </select>
                    </div>
                    <div class="col-md-6 d-flex align-items-end">
                        <button class="btn btn-success me-2" onclick="loadAssignmentOptions()" id="searchBtn">
                            <i class="fas fa-search me-2"></i>Find Available Slots
                        </button>
                        <button class="btn btn-outline-secondary" onclick="clearFilters()">
                            <i class="fas fa-times me-2"></i>Clear Filters
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Assignment Options -->
<div class="row" id="assignmentOptionsContainer" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-list me-2"></i>Available Slots by Priority</h5>
                <small class="text-muted">Pairs with fewer operations of this type are shown first</small>
            </div>
            <div class="card-body">
                <div id="assignmentOptionsContent">
                    <!-- Content will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Assignment Confirmation Modal -->
<div class="modal fade" id="assignmentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-check-circle me-2"></i>Confirm Assignment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="assignmentConfirmationContent">
                    <!-- Content will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="confirmAssignment()">Assign Patient</button>
            </div>
        </div>
    </div>
</div>

<script>
// Global variables
let operations = [];
let currentAssignmentData = null;
let selectedSlot = null;

// Helper function to get cookie value
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
}

// Helper function to get auth headers
function getAuthHeaders() {
    const token = getCookie('access_token');
    return token ? { 'Authorization': `Bearer ${token}` } : {};
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadOperations();
    loadWeekOptions();
});

function loadWeekOptions() {
    // Load week options from the schedule data
    fetch('/api/assignments/', {
        headers: getAuthHeaders()
    })
    .then(response => response.json())
    .then(data => {
        const weekFilter = document.getElementById('weekFilter');
        const weeks = [...new Set(data.map(a => a.week?.week_label).filter(Boolean))].sort();
        
        weeks.forEach(week => {
            const option = document.createElement('option');
            option.value = week;
            option.textContent = week;
            weekFilter.appendChild(option);
        });
    })
    .catch(error => {
        console.error('Error loading week options:', error);
    });
}

function clearFilters() {
    document.getElementById('operationSelect').value = '';
    document.getElementById('patientId').value = '';
    document.getElementById('patientName').value = '';
    document.getElementById('weekFilter').value = '';
    document.getElementById('dayFilter').value = '';
    document.getElementById('timeFilter').value = '';
    document.getElementById('assignmentOptionsContainer').style.display = 'none';
}

async function loadOperations() {
    try {
        const response = await fetch('/api/operations/', {
            headers: getAuthHeaders()
        });
        if (response.ok) {
            operations = await response.json();
            populateOperationSelect();
        } else {
            showError('Failed to load operations');
        }
    } catch (error) {
        console.error('Error loading operations:', error);
        showError('Error loading operations');
    }
}

function populateOperationSelect() {
    const operationSelect = document.getElementById('operationSelect');
    operations.forEach(operation => {
        const option = document.createElement('option');
        option.value = operation.id;
        option.textContent = operation.name;
        operationSelect.appendChild(option);
    });
}

async function loadAssignmentOptions() {
    const operationId = document.getElementById('operationSelect').value;
    const patientId = document.getElementById('patientId').value.trim();
    const patientName = document.getElementById('patientName').value.trim();
    const weekFilter = document.getElementById('weekFilter').value;
    const dayFilter = document.getElementById('dayFilter').value;
    const timeFilter = document.getElementById('timeFilter').value;
    
    if (!operationId) {
        showError('Please select an operation');
        return;
    }
    
    if (!patientId || !patientName) {
        showError('Please enter both Client ID and Client Name');
        return;
    }
    
    // Build URL with filter parameters
    const url = `/api/patient-assignment/${operationId}?week=${encodeURIComponent(weekFilter)}&day=${encodeURIComponent(dayFilter)}&time=${encodeURIComponent(timeFilter)}`;
    const headers = getAuthHeaders();
    
    try {
        const response = await fetch(url, {
            headers: headers
        });
        
        if (response.ok) {
            const data = await response.json();
            displayAssignmentOptions(data);
        } else {
            const errorText = await response.text();
            showError('Failed to load assignment options');
        }
    } catch (error) {
        console.error('Error loading assignment options:', error);
        showError('Error loading assignment options');
    }
}

// Helper function to calculate specific date for a weekday within a week range
function getSpecificDate(weekRange, dayName) {
    // Parse week range like "10/27/2025-10/31/2025"
    const [startDateStr, endDateStr] = weekRange.split('-');
    
    // Parse the start date (which should be Monday)
    const [startMonth, startDay, startYear] = startDateStr.split('/').map(Number);
    const startDate = new Date(startYear, startMonth - 1, startDay); // Month is 0-indexed
    
    // Map day names to numbers (Monday = 0, Tuesday = 1, etc.)
    const dayMap = {
        'Monday': 0,
        'Tuesday': 1,
        'Wednesday': 2,
        'Thursday': 3,
        'Friday': 4,
        'Saturday': 5,
        'Sunday': 6
    };
    
    const targetDay = dayMap[dayName];
    if (targetDay === undefined) return dayName;
    
    // Calculate the specific date by adding the target day offset
    const specificDate = new Date(startDate);
    specificDate.setDate(startDate.getDate() + targetDay);
    
    // Format as MM/DD/YYYY
    const month = (specificDate.getMonth() + 1).toString().padStart(2, '0');
    const day = specificDate.getDate().toString().padStart(2, '0');
    const year = specificDate.getFullYear();
    
    return `${dayName} (${month}/${day}/${year})`;
}

function displayAssignmentOptions(data) {
    const container = document.getElementById('assignmentOptionsContainer');
    const content = document.getElementById('assignmentOptionsContent');
    
    if (data.prioritized_pairs.length === 0) {
        content.innerHTML = '<div class="alert alert-warning">No available slots found for this operation.</div>';
        container.style.display = 'block';
        return;
    }
    
    let html = '';
    
    data.prioritized_pairs.forEach((pair, index) => {
        const priorityClass = index < 3 ? 'border-success' : index < 6 ? 'border-warning' : 'border-secondary';
        
        html += `<div class="card mb-3 ${priorityClass}">`;
        html += `<div class="card-header">`;
        html += `<h6 class="mb-0">`;
        html += `<span class="badge bg-${index < 3 ? 'success' : index < 6 ? 'warning' : 'secondary'} me-2">Priority ${index + 1}</span>`;
        
        // Check if user is front_desk (hide all pair details)
        const isFrontDesk = document.body.getAttribute('data-user-role') === 'front_desk';
        
        if (!isFrontDesk) {
            // Show full details for admin/faculty users
            html += `<strong>${pair.pair_id}</strong> - ${pair.student1_name} & ${pair.student2_name}`;
            html += `<span class="badge bg-info ms-2">${pair.grade_combo}</span>`;
            // Only show operation count if available (for admin/faculty users)
            if (pair.specific_operation_count !== undefined) {
                html += `<span class="badge bg-primary ms-2">${pair.specific_operation_count} operations</span>`;
            }
        } else {
            // Front desk: show grade combo only
            if (pair.grade_combo) {
                html += `<span class="badge bg-info">${pair.grade_combo}</span>`;
            }
        }
        html += `</h6>`;
        html += `</div>`;
        html += `<div class="card-body">`;
        
        if (pair.available_slots.length === 0) {
            html += '<p class="text-muted">No available slots for this pair.</p>';
        } else {
            html += '<div class="row">';
            pair.available_slots.forEach(slot => {
                const specificDate = getSpecificDate(slot.week, slot.day);
                html += `<div class="col-md-4 mb-2">`;
                html += `<div class="card border-primary">`;
                html += `<div class="card-body p-2">`;
                html += `<h6 class="card-title">${slot.chair}</h6>`;
                html += `<p class="card-text small">`;
                html += `<strong>Week:</strong> ${slot.week}<br>`;
                html += `<strong>Day:</strong> ${specificDate}<br>`;
                html += `<strong>Time:</strong> ${slot.time_slot}`;
                html += `</p>`;
                html += `<button class="btn btn-sm btn-primary" onclick="selectSlot(${slot.assignment_id}, '${slot.chair}', '${slot.day}', '${slot.time_slot}', '${slot.week}')">`;
                html += `<i class="fas fa-check me-1"></i>Select`;
                html += `</button>`;
                html += `</div>`;
                html += `</div>`;
                html += `</div>`;
            });
            html += '</div>';
        }
        
        html += `</div>`;
        html += `</div>`;
    });
    
    content.innerHTML = html;
    container.style.display = 'block';
}

function selectSlot(assignmentId, chair, day, timeSlot, week) {
    const operationId = document.getElementById('operationSelect').value;
    const patientId = document.getElementById('patientId').value.trim();
    const patientName = document.getElementById('patientName').value.trim();
    const operationName = document.getElementById('operationSelect').selectedOptions[0].textContent;
    
    selectedSlot = {
        assignmentId: assignmentId,
        chair: chair,
        day: day,
        timeSlot: timeSlot,
        week: week,
        operationId: operationId,
        operationName: operationName,
        patientId: patientId,
        patientName: patientName
    };
    
    // Show confirmation modal
    const specificDate = getSpecificDate(week, day);
    const modalContent = document.getElementById('assignmentConfirmationContent');
    modalContent.innerHTML = `
        <div class="alert alert-info">
            <h6>Assignment Details:</h6>
            <p><strong>Patient:</strong> ${patientName} (ID: ${patientId})</p>
            <p><strong>Operation:</strong> ${operationName}</p>
            <p><strong>Slot:</strong> ${chair} - ${specificDate} ${timeSlot}</p>
            <p><strong>Week:</strong> ${week}</p>
        </div>
        <p>Are you sure you want to assign this patient to the selected slot?</p>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('assignmentModal'));
    modal.show();
}

async function confirmAssignment() {
    if (!selectedSlot) return;
    
    const requestData = {
        assignment_id: parseInt(selectedSlot.assignmentId),
        patient_id: selectedSlot.patientId,
        patient_name: selectedSlot.patientName,
        operation_id: parseInt(selectedSlot.operationId)
    };
    
    try {
        const response = await fetch('/api/patient-assignment/assign', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                ...getAuthHeaders()
            },
            body: JSON.stringify(requestData)
        });
        
        if (response.ok) {
            const result = await response.json();
            showSuccess('Patient assigned successfully!');
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('assignmentModal'));
            modal.hide();
            
            // Clear form
            document.getElementById('patientId').value = '';
            document.getElementById('patientName').value = '';
            document.getElementById('operationSelect').value = '';
            
            // Hide assignment options
            document.getElementById('assignmentOptionsContainer').style.display = 'none';
            
            // Reset variables
            selectedSlot = null;
        } else {
            const errorText = await response.text();
            showError(`Failed to assign patient: ${errorText}`);
        }
    } catch (error) {
        console.error('Error assigning patient:', error);
        showError('Error assigning patient');
    }
}

function refreshData() {
    // Show loading state
    const refreshBtn = document.querySelector('button[onclick="refreshData()"]');
    const originalText = refreshBtn.innerHTML;
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Refreshing...';
    refreshBtn.disabled = true;
    
    // Load data
    loadOperations().finally(() => {
        // Reset button state
        refreshBtn.innerHTML = originalText;
        refreshBtn.disabled = false;
    });
}

function showError(message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-danger mt-3';
    alertDiv.textContent = message;
    
    // Remove existing alerts
    const existingAlerts = document.querySelectorAll('.alert');
    existingAlerts.forEach(alert => alert.remove());
    
    document.querySelector('.container').prepend(alertDiv);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

function showSuccess(message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success mt-3';
    alertDiv.textContent = message;
    
    // Remove existing alerts
    const existingAlerts = document.querySelectorAll('.alert');
    existingAlerts.forEach(alert => alert.remove());
    
    document.querySelector('.container').prepend(alertDiv);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}
</script>
{% endblock %}
