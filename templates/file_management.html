{% extends "base.html" %}

{% block title %}File Management - CNU Dental Clinic Scheduler{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-upload me-2"></i>File Management</h1>
            {% if current_user.role == 'admin' and not students_only %}
            <div>
                <button class="btn btn-success" onclick="initializeOperations()">
                    <i class="fas fa-cog me-2"></i>Initialize Operations
                </button>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- File Upload Section -->
<div class="row g-4 mb-4">
    {% if current_user.role == 'admin' and not students_only %}
    <div class="col-md-6">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-users me-2"></i>Student Data Upload</h5>
            </div>
            <div class="card-body">
                <p class="text-muted">Upload Excel file containing student information</p>
                <p><strong>Required columns:</strong> Student ID, Last Name, First Name, Email, Grade Level, Externship</p>
                
                <form id="studentUploadForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="studentFile" class="form-label">Select Student Data File</label>
                        <input type="file" class="form-control" id="studentFile" name="file" accept=".xlsx,.xls" required>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-upload me-2"></i>Upload Student Data
                    </button>
                </form>
                
                <div id="studentUploadStatus" class="mt-3"></div>
            </div>
        </div>
    </div>
    {% endif %}
    
    {% if current_user.role == 'admin' and not students_only %}
    <div class="col-md-6">
        <div class="card border-info">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Patient Schedule Upload</h5>
            </div>
            <div class="card-body">
                <p class="text-muted">Upload Excel file containing patient schedule</p>
                <p><strong>Required columns:</strong> Day, Time Slot, Chair, Operation, Patient ID, Patient Name</p>
                
                <form id="scheduleUploadForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="scheduleFile" class="form-label">Select Patient Schedule File</label>
                        <input type="file" class="form-control" id="scheduleFile" name="file" accept=".xlsx,.xls" required>
                    </div>
                    <button type="submit" class="btn btn-info">
                        <i class="fas fa-upload me-2"></i>Upload Patient Schedule
                    </button>
                </form>
                
                <div id="scheduleUploadStatus" class="mt-3"></div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Data Status Section -->
<div class="row g-4 mb-4">
    <div class="col-md-4">
        <div class="card border-success">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-users me-2"></i>Students</h5>
            </div>
            <div class="card-body text-center">
                <h3 class="text-success" id="studentCount">0</h3>
                <p class="text-muted">Total Students</p>
                <button class="btn btn-outline-success btn-sm" onclick="viewStudents()">
                    <i class="fas fa-eye me-1"></i>View Details
                </button>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card border-warning">
            <div class="card-header bg-warning text-white">
                <h5 class="mb-0"><i class="fas fa-handshake me-2"></i>Pairs</h5>
            </div>
            <div class="card-body text-center">
                <h3 class="text-warning" id="pairCount">0</h3>
                <p class="text-muted">Student Pairs</p>
                <div class="btn-group" role="group">
                    <button class="btn btn-outline-warning btn-sm" onclick="viewPairs()">
                        <i class="fas fa-eye me-1"></i>View Details
                    </button>
                    {% if current_user.role == 'admin' %}
                    <button class="btn btn-outline-warning btn-sm" id="createPairsBtn" onclick="createStudentPairs()">
                        <i class="fas fa-plus me-1"></i>Create Pairs
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    {% if current_user.role == 'admin' and not students_only %}
    <div class="col-md-4">
        <div class="card border-info">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-calendar-check me-2"></i>Schedule</h5>
            </div>
            <div class="card-body text-center">
                <h3 class="text-info" id="scheduleCount">0</h3>
                <p class="text-muted">Scheduled Treatments</p>
                <button class="btn btn-outline-info btn-sm" onclick="viewSchedule()">
                    <i class="fas fa-eye me-1"></i>View Schedule
                </button>
            </div>
        </div>
    </div>
    {% endif %}
</div>

{% if current_user.role == 'admin' and not students_only %}
<!-- Action Buttons -->
<div class="row g-4 mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-magic me-2"></i>Schedule Generation</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <button class="btn btn-success btn-lg w-100 mb-3" onclick="generateSchedule()" id="generateScheduleBtn" disabled>
                            <i class="fas fa-calendar-plus me-2"></i>Generate Clinic Schedule
                        </button>
                        <p class="text-muted">Automatically assign student pairs to all available slots</p>
                    </div>
                    
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

 

<!-- Students Modal -->
<div class="modal fade" id="studentsModal" tabindex="-1" aria-labelledby="studentsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="studentsModalLabel"><i class="fas fa-users me-2"></i>Student Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="studentsTable"></div>
            </div>
        </div>
    </div>
</div>

<!-- Pairs Modal -->
<div class="modal fade" id="pairsModal" tabindex="-1" aria-labelledby="pairsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="pairsModalLabel"><i class="fas fa-handshake me-2"></i>Student Pairs</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="pairsTable"></div>
            </div>
        </div>
    </div>
</div>

<!-- Schedule Modal -->
<div class="modal fade" id="scheduleModal" tabindex="-1" aria-labelledby="scheduleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="scheduleModalLabel"><i class="fas fa-calendar-check me-2"></i>Schedule Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="scheduleTable"></div>
            </div>
        </div>
    </div>
</div>

<script>
// Global variables
let students = [];
let pairs = [];
let schedule = [];
let operations = [];
let scheduleGenerated = false; // front-end session flag (persisted in localStorage)

// Helper function to get cookie value
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
}

// Helper function to get auth headers
function getAuthHeaders() {
    const token = getCookie('access_token');
    return token ? { 'Authorization': `Bearer ${token}` } : {};
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Restore persisted lock state across refresh
    try {
        const persisted = localStorage.getItem('scheduleGenerated');
        scheduleGenerated = persisted === 'true';
    } catch(e) { /* ignore */ }
    loadData();
    setupFormHandlers();
    // Ensure Bootstrap backdrops are cleaned when modals close
    const modalIds = ['studentsModal','pairsModal','scheduleModal'];
    modalIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.addEventListener('hidden.bs.modal', () => {
                document.body.classList.remove('modal-open');
                const backdrops = document.querySelectorAll('.modal-backdrop');
                backdrops.forEach(b => b.remove());
            });
        }
    });
});

function setupFormHandlers() {
    // Student upload form (guard if hidden on students-only page)
    const studentForm = document.getElementById('studentUploadForm');
    if (studentForm) {
        studentForm.addEventListener('submit', function(e) {
            e.preventDefault();
            uploadStudentFile();
        });
    }
    
    // Schedule upload form (guard if hidden on students-only page)
    const scheduleForm = document.getElementById('scheduleUploadForm');
    if (scheduleForm) {
        scheduleForm.addEventListener('submit', function(e) {
            e.preventDefault();
            uploadScheduleFile();
        });
    }
}

async function loadData() {
    try {
        const headers = getAuthHeaders();
        
        // Load students
        const studentsResponse = await fetch('/api/students/', { headers });
        if (studentsResponse.ok) {
            students = await studentsResponse.json();
            updateStudentCount();
        }
        
        // Load pairs
        const pairsResponse = await fetch('/api/pairs/', { headers });
        if (pairsResponse.ok) {
            pairs = await pairsResponse.json();
            updatePairCount();
        }
        
        // Load schedule assignments
        const scheduleResponse = await fetch('/api/assignments/', { headers });
        if (scheduleResponse.ok) {
            schedule = await scheduleResponse.json();
            updateScheduleCount();
            // If schedule exists in DB, persist lock so buttons remain disabled across sessions
            if (Array.isArray(schedule) && schedule.length > 0) {
                scheduleGenerated = true;
                try { localStorage.setItem('scheduleGenerated', 'true'); } catch(e) {}
            }
        }
        
        // Load operations
        const operationsResponse = await fetch('/api/operations/', { headers });
        if (operationsResponse.ok) {
            operations = await operationsResponse.json();
        }
        
        updateButtonStates();
        
    } catch (error) {
        console.error('Error loading data:', error);
        showStatus('Error loading data: ' + error.message, 'error');
    }
}

function updateStudentCount() {
    const el = document.getElementById('studentCount');
    if (el) el.textContent = students.length;
}

function updatePairCount() {
    const el = document.getElementById('pairCount');
    if (el) el.textContent = pairs.length;
}

function updateScheduleCount() {
    const el = document.getElementById('scheduleCount');
    if (el) el.textContent = schedule.length;
}

function updateButtonStates() {
    const hasStudents = students.length > 0;
    const hasPairs = pairs.length > 0;
    // Lock when a schedule exists in DB or a prior generation was recorded
    const isLocked = !!scheduleGenerated || (Array.isArray(schedule) && schedule.length > 0);

    const genBtn = document.getElementById('generateScheduleBtn');
    if (genBtn) genBtn.disabled = !hasPairs || isLocked;
    const assignBtn = document.getElementById('assignPairsBtn');
    if (assignBtn) assignBtn.disabled = !hasPairs || isLocked; // keep consistent with lock
    const createPairsBtn = document.getElementById('createPairsBtn');
    if (createPairsBtn) {
        createPairsBtn.disabled = isLocked;
        createPairsBtn.title = isLocked ? 'Disabled after schedule generation' : '';
    }
}

async function uploadStudentFile() {
    const form = document.getElementById('studentUploadForm');
    const formData = new FormData(form);
    const statusDiv = document.getElementById('studentUploadStatus');
    
    try {
        statusDiv.innerHTML = '<div class="alert alert-info">Uploading...</div>';
        
        const headers = getAuthHeaders();
        
        const response = await fetch('/api/students/upload', {
            method: 'POST',
            headers: headers,
            body: formData
        });
        
        if (response.ok) {
            const result = await response.json();
            statusDiv.innerHTML = `<div class="alert alert-success">Successfully uploaded ${result.count} students!</div>`;
            // Reset schedule-generated lock on new data and persist
            scheduleGenerated = false;
            try { localStorage.removeItem('scheduleGenerated'); } catch(e) {}
            await loadData();
            updateButtonStates();
        } else {
            const error = await response.json();
            statusDiv.innerHTML = `<div class="alert alert-danger">Upload failed: ${error.detail}</div>`;
        }
    } catch (error) {
        statusDiv.innerHTML = `<div class="alert alert-danger">Upload error: ${error.message}</div>`;
    }
}

async function createStudentPairs() {
    try {
        showStatus('Creating pairs...', 'info');
        
        const headers = getAuthHeaders();
        
        const response = await fetch('/api/students/create-pairs', {
            method: 'POST',
            headers: headers
        });
        
        if (response.ok) {
            const result = await response.json();
            showStatus(result.message, 'success');
            // Reset schedule-generated lock on new data and persist
            scheduleGenerated = false;
            try { localStorage.removeItem('scheduleGenerated'); } catch(e) {}
            await loadData();
            updateButtonStates();
        } else {
            const error = await response.json();
            showStatus(`Create pairs failed: ${error.detail}`, 'error');
        }
    } catch (error) {
        showStatus(`Create pairs error: ${error.message}`, 'error');
    }
}

async function uploadScheduleFile() {
    const form = document.getElementById('scheduleUploadForm');
    const formData = new FormData(form);
    const statusDiv = document.getElementById('scheduleUploadStatus');
    
    try {
        statusDiv.innerHTML = '<div class="alert alert-info">Uploading...</div>';
        
        const headers = getAuthHeaders();
        
        const response = await fetch('/api/schedule/upload', {
            method: 'POST',
            headers: headers,
            body: formData
        });
        
        if (response.ok) {
            const result = await response.json();
            statusDiv.innerHTML = `<div class="alert alert-success">Successfully uploaded ${result.count} schedule entries!</div>`;
            // Uploading a fresh schedule implies we may regenerate; unlock pair editing until generation
            scheduleGenerated = false;
            try { localStorage.removeItem('scheduleGenerated'); } catch(e) {}
            await loadData();
            updateButtonStates();
        } else {
            const error = await response.json();
            statusDiv.innerHTML = `<div class="alert alert-danger">Upload failed: ${error.detail}</div>`;
        }
    } catch (error) {
        statusDiv.innerHTML = `<div class="alert alert-danger">Upload error: ${error.message}</div>`;
    }
}

async function initializeOperations() {
    try {
        showStatus('Initializing default operations...', 'info');
        
        const response = await fetch('/api/operations/initialize', {
            method: 'POST',
            headers: getAuthHeaders()
        });
        
        if (response.ok) {
            showStatus('Default operations initialized successfully!', 'success');
            await loadData();
        } else {
            const error = await response.json();
            showStatus('Failed to initialize operations: ' + error.detail, 'error');
        }
    } catch (error) {
        showStatus('Error initializing operations: ' + error.message, 'error');
    }
}

async function createPairs() {
    try {
        showStatus('Creating student pairs...', 'info');
        
        const response = await fetch('/api/pairs/create', {
            method: 'POST',
            headers: getAuthHeaders()
        });
        
        if (response.ok) {
            const result = await response.json();
            showStatus(`Successfully created ${result.count} pairs!`, 'success');
            await loadData();
        } else {
            const error = await response.json();
            showStatus('Failed to create pairs: ' + error.detail, 'error');
        }
    } catch (error) {
        showStatus('Error creating pairs: ' + error.message, 'error');
    }
}

async function generateSchedule() {
    try {
        showStatus('Generating clinic schedule...', 'info');
        showProgress(true);
        
        const response = await fetch('/api/schedule/generate', {
            method: 'POST',
            headers: getAuthHeaders()
        });
        
        if (response.ok) {
            const result = await response.json();
            showStatus(`Successfully generated schedule with ${result.count} assignments!`, 'success');
            scheduleGenerated = true;
            try { localStorage.setItem('scheduleGenerated', 'true'); } catch(e) {}
            await loadData();
            updateButtonStates();
            // Disable pair creation and editing after schedule is generated
            const cpBtn = document.getElementById('createPairsBtn');
            if (cpBtn) { cpBtn.disabled = true; cpBtn.title = 'Disabled after schedule generation'; }
            const cpmBtn = document.getElementById('createPairManualBtn');
            if (cpmBtn) { cpmBtn.disabled = true; cpmBtn.title = 'Disabled after schedule generation'; }
            document.querySelectorAll('.pair-edit-btn, .pair-delete-btn').forEach(btn=>{
                btn.classList.add('disabled');
                btn.setAttribute('aria-disabled','true');
                btn.title = 'Disabled after schedule generation';
            });
        } else {
            const error = await response.json();
            showStatus('Failed to generate schedule: ' + error.detail, 'error');
        }
    } catch (error) {
        showStatus('Error generating schedule: ' + error.message, 'error');
    } finally {
        showProgress(false);
    }
}

async function assignPairsToSlots() {
    try {
        showStatus('Assigning pairs to patient slots...', 'info');
        showProgress(true);
        
        const response = await fetch('/api/schedule/assign', {
            method: 'POST',
            headers: getAuthHeaders()
        });
        
        if (response.ok) {
            const result = await response.json();
            showStatus(`Successfully assigned pairs to ${result.count} slots!`, 'success');
            await loadData();
        } else {
            const error = await response.json();
            showStatus('Failed to assign pairs: ' + error.detail, 'error');
        }
    } catch (error) {
        showStatus('Error assigning pairs: ' + error.message, 'error');
    } finally {
        showProgress(false);
    }
}

function viewStudents() {
    const modalEl = document.getElementById('studentsModal');
    const modal = new bootstrap.Modal(modalEl);
    const opener = document.activeElement;
    const tableDiv = document.getElementById('studentsTable');
    
    // Ensure modal is properly configured for accessibility
    modalEl.setAttribute('aria-hidden', 'false');
    
    let tableHTML = `
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Student ID</th>
                        <th>Name</th>
                        <th>Grade Level</th>
                        <th>Externship</th>
                        <th>Externship Start</th>
                        <th>Externship End</th>
                        <th>Group</th>
                        <th>Pair ID</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    students.forEach(student => {
        // Format externship dates more robustly
        let externshipStart = 'N/A';
        let externshipEnd = 'N/A';
        
        if (student.externship_start_date) {
            try {
                // Parse date string directly to avoid timezone issues
                const dateStr = student.externship_start_date;
                const [year, month, day] = dateStr.split('-');
                externshipStart = new Date(year, month - 1, day).toLocaleDateString();
            } catch (e) {
                externshipStart = student.externship_start_date; // fallback to raw value
            }
        }
        
        if (student.externship_end_date) {
            try {
                // Parse date string directly to avoid timezone issues
                const dateStr = student.externship_end_date;
                const [year, month, day] = dateStr.split('-');
                externshipEnd = new Date(year, month - 1, day).toLocaleDateString();
            } catch (e) {
                externshipEnd = student.externship_end_date; // fallback to raw value
            }
        }
            
        tableHTML += `
            <tr>
                <td>${student.student_id}</td>
                <td>${student.first_name} ${student.last_name}</td>
                <td>${student.grade_level}</td>
                <td>${student.externship ? 'Yes' : 'No'}</td>
                <td>${externshipStart}</td>
                <td>${externshipEnd}</td>
                <td>${student.group_number || 'N/A'}</td>
                <td>${student.pair_id || 'N/A'}</td>
            </tr>
        `;
    });
    
    tableHTML += `
                </tbody>
            </table>
        </div>
    `;
    
    tableDiv.innerHTML = tableHTML;
    // Focus management to avoid aria-hidden warnings
    modalEl.addEventListener('shown.bs.modal', function(){
        // Ensure aria-hidden is false when modal is shown
        modalEl.setAttribute('aria-hidden', 'false');
        
        const closeBtn = modalEl.querySelector('.btn-close');
        if (closeBtn) {
            closeBtn.addEventListener('click', function(){
                try { this.blur(); } catch(e) {}
                if (opener && document.body.contains(opener)) {
                    try { opener.focus(); } catch(e) {}
                }
            }, { once: true });
        }
    }, { once: true });
    modalEl.addEventListener('hide.bs.modal', function(){
        // Set aria-hidden back to true when hiding
        modalEl.setAttribute('aria-hidden', 'true');
        
        const active = document.activeElement;
        if (active && modalEl.contains(active)) {
            try { active.blur(); } catch(e) {}
        }
        if (opener && document.body.contains(opener)) {
            try { opener.focus(); } catch(e) {}
        }
    }, { once: true });
    modal.show();
}

function viewPairs() {
    const modalEl = document.getElementById('pairsModal');
    const modal = new bootstrap.Modal(modalEl);
    const opener = document.activeElement;
    const tableDiv = document.getElementById('pairsTable');
    
    // Ensure modal is properly configured for accessibility
    modalEl.setAttribute('aria-hidden', 'false');
    
    // Build create form
    let unpaired = students.filter(s => !s.pair_id);
    // If everyone is paired, still allow creation by showing all students
    if (unpaired.length === 0) unpaired = [...students];
    const optionHtml = (stu) => `<option value="${stu.id}">${stu.student_id} - ${stu.first_name || ''} ${stu.last_name || ''} (D${stu.grade_level}${stu.group_number?`, Group ${stu.group_number}`:''})</option>`;
    
    let html = `
      <div class="mb-2 text-danger fw-semibold">Note: You can edit student pairs ONLY before generating the clinic schedule. After a schedule is generated, pairs cannot be edited.</div>
      <div class="card mb-3">
        <div class="card-body">
          <div class="row g-2 align-items-end">
            <div class="col-md-4">
              <label class="form-label">Student 1</label>
              <select id="createS1" class="form-select">
                <option value="">Select student</option>
                ${unpaired.map(optionHtml).join('')}
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Student 2</label>
              <select id="createS2" class="form-select">
                <option value="">Select student</option>
                ${unpaired.map(optionHtml).join('')}
              </select>
            </div>
            <div class="col-md-2">
              <label class="form-label">Group</label>
              <select id="createGroup" class="form-select">
                <option value="1">1</option>
                <option value="2">2</option>
              </select>
            </div>
            <div class="col-md-2">
              <button class="btn btn-primary w-100" id="createPairManualBtn" onclick="createPairManual()"><i class="fas fa-plus me-1"></i>Create Pair</button>
            </div>
          </div>
        </div>
      </div>
    `;
    
    // Pairs table
    html += `
      <div class="table-responsive">
        <table class="table table-striped align-middle">
          <thead>
            <tr>
              <th>Pair ID</th>
              <th>Student 1</th>
              <th>Student 2</th>
              <th>Grade</th>
              <th>Group</th>
              <th style="width: 180px">Actions</th>
            </tr>
          </thead>
          <tbody>
    `;
    // Sort pairs by Group then numeric Pair number (pair_id like G1P12)
    const sortedPairs = [...pairs].sort((a,b)=>{
        const am=a.pair_id.match(/G(\d+)P(\d+)/); const bm=b.pair_id.match(/G(\d+)P(\d+)/);
        if(!am||!bm) return (a.pair_id||'').localeCompare(b.pair_id||'');
        const ag=parseInt(am[1],10), ap=parseInt(am[2],10);
        const bg=parseInt(bm[1],10), bp=parseInt(bm[2],10);
        if(ag!==bg) return ag-bg; return ap-bp;
    });
    
    const lockedForPairs = !!scheduleGenerated;
    sortedPairs.forEach(pair => {
        const gradeCombo = `D${pair.student1?.grade_level || '?'}-D${pair.student2?.grade_level || '?'}`;
        html += `
          <tr id="pair-row-${pair.id}">
            <td><strong>${pair.pair_id}</strong></td>
            <td>${pair.student1.first_name} ${pair.student1.last_name} <small class="text-muted">(${pair.student1.student_id})</small></td>
            <td>${pair.student2.first_name} ${pair.student2.last_name} <small class="text-muted">(${pair.student2.student_id})</small></td>
            <td><span class="badge bg-info">${gradeCombo}</span></td>
            <td><span class="badge bg-secondary">Group ${pair.group_number}</span></td>
            <td>
              <button class="btn btn-sm btn-primary me-2 pair-edit-btn" ${lockedForPairs?'disabled aria-disabled="true" title="Disabled after schedule generation"':''} onclick="editPair(${pair.id})"><i class="fas fa-edit me-1"></i>Edit</button>
              <button class="btn btn-sm btn-outline-danger pair-delete-btn" ${lockedForPairs?'disabled aria-disabled="true" title="Disabled after schedule generation"':''} onclick="deletePair(${pair.id})"><i class="fas fa-trash me-1"></i>Delete</button>
            </td>
          </tr>
        `;
    });
    
    html += `
          </tbody>
        </table>
      </div>
    `;
    
    tableDiv.innerHTML = html;
    // Focus management to avoid aria-hidden warnings
    modalEl.addEventListener('shown.bs.modal', function(){
        // Ensure aria-hidden is false when modal is shown
        modalEl.setAttribute('aria-hidden', 'false');
        
        const closeBtn = modalEl.querySelector('.btn-close');
        if (closeBtn) {
            closeBtn.addEventListener('click', function(){
                try { this.blur(); } catch(e) {}
                if (opener && document.body.contains(opener)) {
                    try { opener.focus(); } catch(e) {}
                }
            }, { once: true });
        }
    }, { once: true });
    modalEl.addEventListener('hide.bs.modal', function(){
        // Set aria-hidden back to true when hiding
        modalEl.setAttribute('aria-hidden', 'true');
        
        const active = document.activeElement;
        if (active && modalEl.contains(active)) {
            try { active.blur(); } catch(e) {}
        }
        if (opener && document.body.contains(opener)) {
            try { opener.focus(); } catch(e) {}
        }
    }, { once: true });
    // Follow the same rule as Edit/Delete: lock only after Generate in this session
    const locked = !!scheduleGenerated;
    if (locked) {
        const cpmBtn = document.getElementById('createPairManualBtn');
        if (cpmBtn) { cpmBtn.disabled = true; cpmBtn.title = 'Disabled after schedule generation'; }
    }
    modal.show();
}

function getUnpairedOptions(allowIds = []){
  const set = new Set(allowIds);
  let pool = students.filter(s => set.has(s.id) || !s.pair_id);
  if (pool.length === 0) pool = [...students];
  return pool.map(s => `<option value="${s.id}">${s.student_id} - ${s.first_name || ''} ${s.last_name || ''} (D${s.grade_level}${s.group_number?`, Group ${s.group_number}`:''})</option>`).join('');
}

async function createPairManual(){
  const s1 = document.getElementById('createS1').value;
  const s2 = document.getElementById('createS2').value;
  const g = document.getElementById('createGroup').value;
  if(!s1 || !s2 || s1 === s2){ alert('Select two different students'); return; }
  try{
    const res = await fetch(`/api/pairs/manual?student1_id=${s1}&student2_id=${s2}&group_number=${g}`, { method:'POST', headers: getAuthHeaders() });
    if(!res.ok){ const e = await res.json(); alert(e.detail || 'Create failed'); return; }
    await loadData();
    viewPairs();
  }catch(e){ alert('Create failed'); }
}

function editPair(id){
  if (scheduleGenerated) { return; }
  const pair = pairs.find(p=>p.id===id);
  if(!pair) return;
  const row = document.getElementById(`pair-row-${id}`);
  const options = getUnpairedOptions([pair.student1_id, pair.student2_id]);
  row.innerHTML = `
    <td><strong>${pair.pair_id}</strong></td>
    <td><select id="edit-s1-${id}" class="form-select form-select-sm">${options}</select></td>
    <td><select id="edit-s2-${id}" class="form-select form-select-sm">${options}</select></td>
    <td><span class="badge bg-info">Edit</span></td>
    <td>
      <select id="edit-group-${id}" class="form-select form-select-sm">
        <option value="1" ${pair.group_number===1?'selected':''}>1</option>
        <option value="2" ${pair.group_number===2?'selected':''}>2</option>
      </select>
    </td>
    <td>
      <button class="btn btn-sm btn-success me-2" onclick="savePair(${id})"><i class="fas fa-save me-1"></i>Save</button>
      <button class="btn btn-sm btn-secondary" onclick="viewPairs()">Cancel</button>
    </td>
  `;
  document.getElementById(`edit-s1-${id}`).value = pair.student1_id;
  document.getElementById(`edit-s2-${id}`).value = pair.student2_id;
}

async function savePair(id){
  const s1 = document.getElementById(`edit-s1-${id}`).value;
  const s2 = document.getElementById(`edit-s2-${id}`).value;
  const g = document.getElementById(`edit-group-${id}`).value;
  if(!s1 || !s2 || s1===s2){ alert('Select two different students'); return; }
  try{
    const res = await fetch(`/api/pairs/${id}?student1_id=${s1}&student2_id=${s2}&group_number=${g}`, { method:'PUT', headers: getAuthHeaders() });
    if(!res.ok){ const e = await res.json(); alert(e.detail || 'Update failed'); return; }
    await loadData();
    viewPairs();
  }catch(e){ alert('Update failed'); }
}

async function deletePair(id){
  if (scheduleGenerated) { return; }
  if(!confirm('Delete this pair?')) return;
  try{
    const res = await fetch(`/api/pairs/${id}`, { method:'DELETE', headers: getAuthHeaders() });
    if(!res.ok){ const e = await res.json(); alert(e.detail || 'Delete failed'); return; }
    await loadData();
    viewPairs();
  }catch(e){ alert('Delete failed'); }
}

function viewSchedule() {
    const modalEl = document.getElementById('scheduleModal');
    const modal = new bootstrap.Modal(modalEl);
    const opener = document.activeElement;
    const tableDiv = document.getElementById('scheduleTable');
    
    // Ensure modal is properly configured for accessibility
    modalEl.setAttribute('aria-hidden', 'false');
    
    let tableHTML = `
        <div class="table-responsive">
            <table class="table table-striped table-sm">
                <thead>
                    <tr>
                        <th>Week</th>
                        <th>Day</th>
                        <th>Time Slot</th>
                        <th>Chair</th>
                        <th>Operation</th>
                        <th>Patient</th>
                        <th>Pair</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    schedule.forEach(assignment => {
        tableHTML += `
            <tr>
                <td>${assignment.week?.week_label || 'N/A'}</td>
                <td>${assignment.day}</td>
                <td>${assignment.time_slot}</td>
                <td>${assignment.chair}</td>
                <td>${assignment.operation?.name || 'N/A'}</td>
                <td>${assignment.patient_name || 'N/A'}</td>
                <td>${assignment.pair?.pair_id || 'N/A'}</td>
                <td><span class="badge bg-${assignment.status === 'assigned' ? 'success' : 'secondary'}">${assignment.status}</span></td>
            </tr>
        `;
    });
    
    tableHTML += `
                </tbody>
            </table>
        </div>
    `;
    
    tableDiv.innerHTML = tableHTML;
    
    // Focus management to avoid aria-hidden warnings
    modalEl.addEventListener('shown.bs.modal', function(){
        // Ensure aria-hidden is false when modal is shown
        modalEl.setAttribute('aria-hidden', 'false');
        
        const closeBtn = modalEl.querySelector('.btn-close');
        if (closeBtn) {
            closeBtn.addEventListener('click', function(){
                try { this.blur(); } catch(e) {}
                if (opener && document.body.contains(opener)) {
                    try { opener.focus(); } catch(e) {}
                }
            }, { once: true });
        }
    }, { once: true });
    modalEl.addEventListener('hide.bs.modal', function(){
        // Set aria-hidden back to true when hiding
        modalEl.setAttribute('aria-hidden', 'true');
        
        const active = document.activeElement;
        if (active && modalEl.contains(active)) {
            try { active.blur(); } catch(e) {}
        }
        if (opener && document.body.contains(opener)) {
            try { opener.focus(); } catch(e) {}
        }
    }, { once: true });
    
    modal.show();
}

function showStatus(message, type) {
    const alertClass = type === 'error' ? 'alert-danger' : 
                      type === 'success' ? 'alert-success' : 'alert-info';
    let statusDiv = document.getElementById('statusMessages');
    if (!statusDiv) {
        const container = document.querySelector('.container') || document.body;
        statusDiv = document.createElement('div');
        statusDiv.id = 'statusMessages';
        statusDiv.className = 'my-3';
        container.prepend(statusDiv);
    }
    // For success, only show centered overlay (no inline bar near navbar)
    if (type === 'success') {
        statusDiv.innerHTML = '';
        const existing = document.getElementById('statusOverlay');
        if (existing) existing.remove();
        const overlay = document.createElement('div');
        overlay.id = 'statusOverlay';
        overlay.style.position = 'fixed';
        overlay.style.left = '50%';
        overlay.style.top = '50%';
        overlay.style.transform = 'translate(-50%, -50%)';
        overlay.style.zIndex = '5000';
        overlay.style.maxWidth = '80%';
        overlay.style.minWidth = '300px';
        overlay.style.pointerEvents = 'none';
        overlay.innerHTML = `<div class="alert ${alertClass} text-center shadow" style="font-size:1.25rem; padding: 0.75rem 1.25rem;">${message}</div>`;
        document.body.appendChild(overlay);
        setTimeout(() => { const el = document.getElementById('statusOverlay'); if (el) el.remove(); }, 2500);
        return;
    }
    // Non-success: show inline alert at top of container
    statusDiv.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
    setTimeout(() => { if (statusDiv) statusDiv.innerHTML = ''; }, 5000);
}

function showProgress(show) {
    const container = document.getElementById('progressContainer');
    const bar = document.getElementById('progressBar');
    if (!container || !bar) return; // Graceful no-op if progress UI is not present
    if (show) {
        container.style.display = 'block';
        bar.style.width = '0%';
        let progress = 0;
        const interval = setInterval(() => {
            progress += Math.random() * 10;
            if (progress >= 90) {
                clearInterval(interval);
                progress = 90;
            }
            bar.style.width = progress + '%';
        }, 200);
        container.dataset.interval = interval;
    } else {
        container.style.display = 'none';
        if (container.dataset.interval) {
            clearInterval(container.dataset.interval);
        }
        bar.style.width = '100%';
        setTimeout(() => { bar.style.width = '0%'; }, 500);
    }
}
</script>
{% endblock %}
